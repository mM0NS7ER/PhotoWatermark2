# 照片水印应用 - 技术架构图

## 1. 系统架构概述

照片水印应用采用分层架构设计，将系统分为表现层、业务逻辑层和数据访问层，确保各层职责清晰，便于开发和维护。

### 1.1 架构层次
```
┌─────────────────────────────────────────────────────┐
│                   表现层 (UI Layer)                  │
├─────────────────────────────────────────────────────┤
│                   业务逻辑层                        │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐ │
│  │ 文件处理模块│  │ 水印处理模块│  │ 配置管理模块│ │
│  └─────────────┘  └─────────────┘  └─────────────┘ │
├─────────────────────────────────────────────────────┤
│                   数据访问层                        │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐ │
│  │ 图片存储    │  │ 模板存储    │  │ 配置存储    │ │
│  └─────────────┘  └─────────────┘  └─────────────┘ │
└─────────────────────────────────────────────────────┘
```

### 1.2 核心模块说明

#### 1.2.1 表现层 (UI Layer)
- **主窗口 (MainWindow)**: 应用程序的主界面，包含菜单栏、工具栏和状态栏
- **图片列表视图 (ImageView)**: 显示已导入图片的列表，支持选择和预览
- **图片预览区 (PreviewArea)**: 显示当前选中图片的预览和水印效果
- **水印控制面板 (WatermarkControlPanel)**: 提供水印设置的各种控件
- **导出设置面板 (ExportPanel)**: 提供导出选项设置

#### 1.2.2 业务逻辑层
- **文件处理模块 (FileProcessor)**: 处理图片的导入、导出和格式转换
- **水印处理模块 (WatermarkProcessor)**: 处理文本和图片水印的生成和应用
- **配置管理模块 (ConfigManager)**: 管理应用配置和水印模板

#### 1.2.3 数据访问层
- **图片存储 (ImageStorage)**: 负责图片文件的读写操作
- **模板存储 (TemplateStorage)**: 负责水印模板的保存和加载
- **配置存储 (ConfigStorage)**: 负责应用配置的保存和加载

## 2. 模块交互流程

### 2.1 图片导入流程
```
用户选择图片 → 文件处理模块验证格式 → 图片列表视图更新 → 图片预览区显示
```

### 2.2 水印应用流程
```
用户调整水印设置 → 水印处理模块生成水印 → 图片预览区实时显示 → 用户确认导出
```

### 2.3 图片导出流程
```
用户设置导出选项 → 文件处理模块应用水印 → 按命名规则保存 → 更新图片列表视图
```

## 3. 类图

### 3.1 核心类关系
```
┌─────────────────────┐       ┌─────────────────────┐
│      MainWindow     │       │    ConfigManager    │
├─────────────────────┤       ├─────────────────────┤
│ - image_list_view   │       │ - templates         │
│ - preview_area      │<>─────│ - settings          │
│ - watermark_panel   │       │ - config_file       │
│ - export_panel      │       └─────────────────────┘
├─────────────────────┤
│ + show()            │
│ + import_images()   │       ┌─────────────────────┐
│ + export_images()   │       │   FileProcessor     │
└─────────────────────┘       ├─────────────────────┤
       ▲                        │ - input_formats     │
       │                        │ - output_formats    │
       │                        │ - output_folder     │
┌─────────────────────┐       │ - naming_rules      │
│   ImageView         │       ├─────────────────────┤
├─────────────────────┤       │ + import_images()   │
│ - image_list        │       │ + export_images()   │
│ - current_image     │       │ + validate_format() │
├─────────────────────┤       └─────────────────────┘
│ + update_list()      │              ▲
│ + select_image()    │              │
└─────────────────────┘              │
       ▲                             │
       │                             │
┌─────────────────────┐       ┌─────────────────────┐
│  PreviewArea        │       │ WatermarkProcessor  │
├─────────────────────┤       ├─────────────────────┤
│ - current_image     │       │ - text_watermark    │
│ - watermark_image   │       │ - image_watermark   │
├─────────────────────┤       │ - position          │
│ + update_preview()   │       │ + apply_watermark() │
│ + drag_watermark()  │       │ + create_template() │
└─────────────────────┘       └─────────────────────┘
```

## 4. 数据流图

### 4.1 图片处理数据流
```
[用户输入] → [文件选择] → [格式验证] → [图片加载] → [预览显示] 
    ↑                                                        ↓
[水印设置] ← [水印应用] ← [水印生成] ← [水印参数调整] ← [用户界面]
```

### 4.2 导出处理数据流
```
[导出设置] → [文件命名] → [水印应用] → [格式转换] → [文件保存] → [结果反馈]
```

## 5. 部署架构

### 5.1 应用部署结构
```
PhotoWatermarkApp/
├── main.py              # 应用入口
├── resources/           # 资源文件
│   ├── icons/           # 图标文件
│   └── styles/          # 样式文件
├── ui/                  # UI层代码
│   ├── __init__.py
│   ├── main_window.py   # 主窗口
│   ├── image_view.py    # 图片列表视图
│   ├── preview_area.py  # 图片预览区
│   ├── watermark_panel.py # 水印控制面板
│   └── export_panel.py  # 导出设置面板
├── core/                # 业务逻辑层代码
│   ├── __init__.py
│   ├── file_processor.py # 文件处理模块
│   ├── watermark_processor.py # 水印处理模块
│   └── config_manager.py # 配置管理模块
├── data/                # 数据访问层代码
│   ├── __init__.py
│   ├── image_storage.py  # 图片存储
│   ├── template_storage.py # 模板存储
│   └── config_storage.py # 配置存储
├── utils/               # 工具类
│   ├── __init__.py
│   ├── image_utils.py   # 图片处理工具
│   └── ui_utils.py      # UI工具函数
└── requirements.txt     # 依赖包列表
```

## 6. 关键技术点

### 6.1 图片处理性能优化
- 使用多线程处理批量图片
- 采用懒加载技术，只在需要时加载大尺寸图片
- 图片处理操作使用高效的图像处理库

### 6.2 实时预览实现
- 使用双缓冲技术减少闪烁
- 仅在参数变化时重新生成预览
- 对大尺寸图片进行适当缩放显示

### 6.3 配置与模板管理
- 使用JSON格式存储配置和模板
- 实现配置变更的自动保存
- 提供配置导入导出功能
